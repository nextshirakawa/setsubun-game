<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>鬼退治バトル - ボス攻撃実装版</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        canvas { display: block; background: #222; border: 2px solid #444; }
        .hud { position: absolute; top: 10px; width: 90%; display: flex; justify-content: space-between; pointer-events: none; z-index: 10; }
        .score-box { font-size: 14px; font-weight: bold; background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 15px; border: 1px solid #555; }
        .level-box { position: absolute; top: 45px; left: 5%; color: #00ffcc; font-size: 16px; font-weight: bold; text-shadow: 1px 1px 2px black; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; text-align: center; }
        button { padding: 15px 40px; font-size: 20px; cursor: pointer; background: #00ffcc; border: none; border-radius: 30px; margin: 20px; font-weight: bold; box-shadow: 0 4px 0 #008877; }
        
        #boss-alert {
            display: none; position: absolute; top: 40%; width: 100%; text-align: center;
            color: #ff0000; font-size: 48px; font-weight: bold; text-shadow: 0 0 20px #ff0000;
            z-index: 15; pointer-events: none; animation: blink 0.5s infinite alternate;
        }
        @keyframes blink { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1.1); } }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="boss-alert">なまはげ襲来</div>
        <div class="hud">
            <div class="score-box">SCORE: <span id="score">0</span></div>
            <div class="score-box" style="color:#ffcc00;">HI: <span id="high-score">100000</span></div>
        </div>
        <div class="level-box">PLAYER LV: <span id="p-level">1</span></div>
        <canvas id="gameCanvas"></canvas>

        <div id="start-menu" class="overlay">
            <h1>鬼退治バトル</h1>
            <p id="loading-msg">画像を読み込み中...</p>
            <div id="error-log" style="color:#ff4444; font-size:12px;"></div>
            <button id="start-btn" onclick="startGame()" style="display:none;">ゲーム開始</button>
        </div>

        <div id="gameover-menu" class="overlay" style="display:none;">
            <h1>GAME OVER</h1>
            <p>最終スコア: <span id="final-score">0</span></p>
            <button onclick="startGame()">もう一度</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('p-level');
        const bossAlert = document.getElementById('boss-alert');
        const errorLog = document.getElementById('error-log');

        // --- 1. 画像アセット（ボスの弾を追加） ---
        const assets = {
            player: { src: 'hero.png', img: new Image() },
            enemy1: { src: 'enemy_red.png', img: new Image() },
            enemy2: { src: 'enemy_blue.png', img: new Image() },
            boss: { src: 'enemy_boss.png', img: new Image() },
            bossBullet: { src: 'bullet_boss.png', img: new Image() }, // 新規追加
            item: { src: 'item_masu.png', img: new Image() },
            bullet: { src: 'bullet_mame.png', img: new Image() }
        };

        let loadedCount = 0;
        for (let key in assets) {
            assets[key].img.src = assets[key].src;
            assets[key].img.onload = () => {
                if (++loadedCount === Object.keys(assets).length) {
                    document.getElementById('loading-msg').style.display = 'none';
                    document.getElementById('start-btn').style.display = 'block';
                }
            };
            assets[key].img.onerror = () => { errorLog.innerHTML += `✕ "${assets[key].src}" が見つかりません<br>`; };
        }

        // --- 2. ゲーム変数 ---
        let gameState = 'title';
        let score = 0, pLevel = 1, enemiesDefeated = 0;
        let enemies = [], bullets = [], powerUps = [];
        let boss = null, bossTriggered = false;
        let bossBullets = []; // ボスの弾専用配列

        function resize() {
            canvas.width = Math.min(window.innerWidth, 450);
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        const player = { x: 0, y: 0, width: 50, height: 65 };

        function moveHandler(e) {
            if (gameState !== 'playing') return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const rect = canvas.getBoundingClientRect();
            player.x = (clientX - rect.left) - player.width / 2;
        }
        window.addEventListener('mousemove', moveHandler);
        window.addEventListener('touchmove', moveHandler, { passive: false });
        window.addEventListener('mousedown', () => { if(gameState === 'playing') fire(); });
        window.addEventListener('touchstart', (e) => { if(gameState === 'playing') { fire(); e.preventDefault(); } }, { passive: false });

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, duration, vol) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        // --- 5. ボスクラス（攻撃機能追加） ---
        class Boss {
            constructor() {
                this.width = 120; this.height = 140;
                this.x = canvas.width / 2 - this.width / 2;
                this.y = -200; this.hp = 100; this.maxHp = 100;
                this.vx = 2.5; // 少しスピードアップ
                this.targetY = 80; this.state = 'entering';
                this.attackTimer = 0; // 攻撃用タイマー
            }
            update() {
                if (this.state === 'entering') {
                    this.y += 1.5; if (this.y >= this.targetY) this.state = 'battle';
                } else {
                    // 移動
                    this.x += this.vx; if (this.x <= 0 || this.x > canvas.width - this.width) this.vx *= -1;
                    
                    // 攻撃ルーチン
                    this.attackTimer++;
                    if (this.attackTimer > 50) { // 約0.8秒ごとに発射
                        this.fire();
                        this.attackTimer = 0;
                    }
                }
            }
            fire() {
                const bx = this.x + this.width / 2;
                const by = this.y + this.height - 20;
                const speed = 6;
                playSound(300, 'square', 0.1, 0.1); // ボス攻撃音
                // 3方向ショット
                bossBullets.push({x: bx, y: by, vx: 0, vy: speed, size: 25});      // 中央
                bossBullets.push({x: bx, y: by, vx: -2.5, vy: speed-1, size: 25}); // 左斜め
                bossBullets.push({x: bx, y: by, vx: 2.5, vy: speed-1, size: 25});  // 右斜め
            }
            draw() {
                ctx.drawImage(assets.boss.img, this.x, this.y, this.width, this.height);
                const barW = 200;
                ctx.fillStyle = '#444'; ctx.fillRect(canvas.width/2 - barW/2, 50, barW, 10);
                ctx.fillStyle = '#ff0000'; ctx.fillRect(canvas.width/2 - barW/2, 50, barW * (this.hp/this.maxHp), 10);
            }
        }

        // --- 6. メインループ ---
        function update() {
            if (gameState === 'playing') {
                ctx.fillStyle = '#222'; ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (score >= 10000 && !bossTriggered) { triggerBoss(); }

                // プレイヤーの弾丸
                bullets.forEach((b, i) => {
                    b.x += b.vx; b.y += b.vy;
                    ctx.drawImage(assets.bullet.img, b.x - 7, b.y - 7, 14, 14);
                    if (boss && b.x > boss.x && b.x < boss.x + boss.width && b.y > boss.y && b.y < boss.y + boss.height) {
                        boss.hp--; bullets.splice(i, 1); playSound(150, 'sawtooth', 0.1, 0.05);
                        if (boss.hp <= 0) defeatBoss();
                    }
                    if (b.y < -20 || b.x < -20 || b.x > canvas.width + 20) bullets.splice(i, 1);
                });

                // ボスの弾丸（新規追加）
                bossBullets.forEach((b, i) => {
                    b.x += b.vx; b.y += b.vy;
                    ctx.drawImage(assets.bossBullet.img, b.x - b.size/2, b.y - b.size/2, b.size, b.size);
                    // プレイヤーとの当たり判定（当たれば即死）
                    if (b.x > player.x && b.x < player.x + player.width && b.y > player.y + 10 && b.y < player.y + player.height) {
                        gameOver();
                    }
                    if (b.y > canvas.height + 20) bossBullets.splice(i, 1);
                });

                // アイテム
                powerUps.forEach((p, i) => {
                    p.y += 3; ctx.globalAlpha = (Math.floor(Date.now() / 200) % 2 === 0) ? 0.5 : 1.0;
                    ctx.drawImage(assets.item.img, p.x, p.y, 35, 35); ctx.globalAlpha = 1.0;
                    if (p.x < player.x + player.width && p.x + 35 > player.x && p.y < player.y + player.height && p.y + 35 > player.y) {
                        playSound(1500, 'sine', 0.2, 0.1);
                        if (pLevel < 5) { pLevel++; levelElement.innerText = pLevel; } else { score += 1000; scoreElement.innerText = score; }
                        powerUps.splice(i, 1);
                    }
                    if (p.y > canvas.height) powerUps.splice(i, 1);
                });

                if (boss) {
                    boss.update(); boss.draw();
                    // 本体接触判定
                    if (boss.x < player.x + player.width && boss.x + boss.width > player.x && boss.y < player.y + player.height && boss.y + boss.height > player.y) gameOver();
                } else {
                    enemies.forEach((e, i) => {
                        e.y += e.speed; ctx.drawImage(e.img, e.x, e.y, 45, 55);
                        if (e.y + 55 > canvas.height - 30) {
                            if (pLevel === 5) { pLevel = 4; levelElement.innerText = 4; enemies.splice(i, 1); playSound(200, 'sawtooth', 0.5, 0.2); } else gameOver();
                        }
                        bullets.forEach((b, bi) => {
                            if (b.x > e.x && b.x < e.x + 45 && b.y > e.y && b.y < e.y + 55) {
                                playSound(150, 'sawtooth', 0.1, 0.05);
                                enemies.splice(i, 1); bullets.splice(bi, 1);
                                score += 100; enemiesDefeated++; scoreElement.innerText = score;
                            }
                        });
                    });
                }

                if (pLevel === 5) {
                    ctx.strokeStyle = '#00ffff'; ctx.lineWidth = 3; ctx.beginPath();
                    ctx.arc(player.x + player.width/2, player.y + player.height/2, 45, 0, Math.PI*2); ctx.stroke();
                }
                ctx.drawImage(assets.player.img, player.x, player.y, player.width, player.height);
            }
            requestAnimationFrame(update);
        }

        // --- 7. ゲーム制御 ---
        function triggerBoss() {
            bossTriggered = true; enemies = []; powerUps = []; // アイテムも消す
            bossAlert.style.display = 'block'; playSound(100, 'sawtooth', 1.5, 0.3);
            setTimeout(() => { bossAlert.style.display = 'none'; boss = new Boss(); }, 3000);
        }

        function defeatBoss() {
            boss = null; bossBullets = []; // ボスの弾も消す
            score += 1000000; scoreElement.innerText = score; playSound(400, 'sine', 1.0, 0.3);
        }

        function fire() {
            const bx = player.x + player.width / 2, by = player.y, spd = 12;
            playSound(1000, 'sine', 0.1, 0.04);
            if (pLevel === 1) bullets.push({x: bx, y: by, vx: 0, vy: -spd});
            else if (pLevel === 2) bullets.push({x: bx-12, y: by, vx: 0, vy: -spd}, {x: bx+12, y: by, vx: 0, vy: -spd});
            else if (pLevel === 3) bullets.push({x: bx-18, y: by, vx: 0, vy: -spd}, {x: bx, y: by, vx: 0, vy: -spd}, {x: bx+18, y: by, vx: 0, vy: -spd});
            else if (pLevel >= 4) bullets.push({x: bx, y: by, vx: 0, vy: -spd}, {x: bx, y: by, vx: -3, vy: -spd+1}, {x: bx, y: by, vx: 3, vy: -spd+1});
        }

        function spawnLoop() {
            if (gameState !== 'playing') return;
            const isBossEvent = boss || bossAlert.style.display === 'block';
            if (!isBossEvent) {
                if (Math.random() < 0.15) powerUps.push({ x: Math.random() * (canvas.width - 35), y: -40 });
                else {
                    const img = Math.random() > 0.5 ? assets.enemy1.img : assets.enemy2.img;
                    enemies.push({ x: Math.random() * (canvas.width - 45), y: -60, speed: 2 + (enemiesDefeated * 0.05), img: img });
                }
            }
            setTimeout(spawnLoop, Math.max(300, 900 - (enemiesDefeated * 10)));
        }

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            score = 0; pLevel = 1; enemiesDefeated = 0; bossTriggered = false; boss = null;
            enemies = []; bullets = []; powerUps = []; bossBullets = [];
            player.x = canvas.width / 2 - player.width / 2; player.y = canvas.height - 120;
            gameState = 'playing'; scoreElement.innerText = '0'; levelElement.innerText = '1';
            document.getElementById('start-menu').style.display = 'none';
            document.getElementById('gameover-menu').style.display = 'none';
            bossAlert.style.display = 'none';
            spawnLoop();
        }

        function gameOver() {
            gameState = 'gameover'; document.getElementById('final-score').innerText = score;
            document.getElementById('gameover-menu').style.display = 'flex';
        }
        update();
    </script>
</body>
</html>